<!DOCTYPE html>
<!-- Â© 2026 Orlando - GRC Risk Assessment Tool. All rights reserved. -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Risk Assessment</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;700&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2236;
    --border: #1f2d45;
    --accent: #00e5ff;
    --accent2: #ff4d6d;
    --accent3: #7fff6e;
    --text: #e2e8f0;
    --muted: #64748b;
    --critical: #ff4d6d;
    --high: #ff9f40;
    --medium: #ffd166;
    --low: #7fff6e;
    --info: #00e5ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    min-height: 100vh;
    padding: 2rem 1rem;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
      radial-gradient(ellipse at 10% 20%, rgba(0,229,255,0.04) 0%, transparent 50%),
      radial-gradient(ellipse at 90% 80%, rgba(255,77,109,0.04) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  header {
    margin-bottom: 2.5rem;
    border-left: 3px solid var(--accent);
    padding-left: 1.25rem;
    animation: fadeIn 0.6s ease;
  }

  header .label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 0.4rem;
  }

  header h1 {
    font-size: 1.9rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  header p {
    color: var(--muted);
    font-size: 0.9rem;
    margin-top: 0.4rem;
  }

  /* Summary Dashboard */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
    animation: fadeIn 0.7s ease 0.1s both;
  }

  .summary-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: border-color 0.2s;
  }

  .summary-card .count {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 2rem;
    font-weight: 600;
    line-height: 1;
  }

  .summary-card .label {
    font-size: 0.72rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-top: 0.3rem;
  }

  .summary-card.critical .count { color: var(--critical); }
  .summary-card.high .count { color: var(--high); }
  .summary-card.medium .count { color: var(--medium); }
  .summary-card.low .count { color: var(--low); }

  /* Meta fields */
  .meta-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
    animation: fadeIn 0.7s ease 0.15s both;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .field label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.68rem;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .field input, .field select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.875rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .field input:focus, .field select:focus {
    border-color: var(--accent);
  }

  .field select option { background: var(--surface2); }

  /* Risk Table */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    animation: fadeIn 0.7s ease 0.2s both;
  }

  .section-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .btn {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    padding: 0.4rem 0.9rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .btn:hover {
    background: var(--accent);
    color: var(--bg);
  }

  .btn.danger {
    border-color: var(--critical);
    color: var(--critical);
  }
  .btn.danger:hover {
    background: var(--critical);
    color: #fff;
  }

  .risk-table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow-x: auto;
    overflow-y: auto;
    max-height: 420px;
    animation: fadeIn 0.7s ease 0.25s both;
    margin-bottom: 2rem;
  }

  /* Sticky header so columns stay visible while scrolling */
  #risk-table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--surface2);
  }


  table {
    width: 100%;
    min-width: 1100px;
    border-collapse: collapse;
  }

  thead th {
    background: var(--surface2);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.67rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0.9rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }

  tbody td {
    padding: 0.65rem 1rem;
    font-size: 0.85rem;
    vertical-align: middle;
  }

  tbody td input, tbody td select, tbody td textarea {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 0.35rem 0.6rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.85rem;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
    resize: none;
  }

  tbody td input:focus, tbody td select:focus, tbody td textarea:focus {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  tbody td select option { background: var(--surface2); }

  .col-num    { width: 36px; }
  .col-id     { min-width: 90px; }
  .col-threat { min-width: 200px; }
  .col-cat    { min-width: 170px; }
  .col-lik    { width: 100px; text-align: center; }
  .col-imp    { width: 100px; text-align: center; }
  .col-score  { width: 70px; text-align: center; }
  .col-rating { width: 110px; }
  .col-owner  { min-width: 130px; }
  .col-mit    { min-width: 210px; }
  .col-status { min-width: 130px; }
  .col-del    { width: 90px; text-align: center; }

  .risk-badge {
    display: inline-block;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.2rem 0.6rem;
    border-radius: 100px;
    border: 1px solid;
  }

  .badge-critical { color: var(--critical); border-color: var(--critical); background: rgba(255,77,109,0.1); }
  .badge-high { color: var(--high); border-color: var(--high); background: rgba(255,159,64,0.1); }
  .badge-medium { color: var(--medium); border-color: var(--medium); background: rgba(255,209,102,0.1); }
  .badge-low { color: var(--low); border-color: var(--low); background: rgba(127,255,110,0.1); }

  .score-cell {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
  }



  .matrix-grid {
    display: grid;
    grid-template-columns: 40px repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr) 40px 28px;
    gap: 3px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    flex: 1;
  }

  .matrix-cell {
    border-radius: 4px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.85rem;
    font-weight: 600;
    position: relative;
    cursor: default;
    transition: transform 0.15s;
  }

  .matrix-cell:hover { transform: scale(1.05); z-index: 2; }

  .axis-label {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .y-axis-title {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: #ffffff;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    grid-row: 1 / 6;
    grid-column: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .x-axis-title {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: #ffffff;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    grid-row: 7;
    grid-column: 2 / 7;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 0.1rem;
  }

  .dot-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    border: 2px solid rgba(255,255,255,0.8);
    position: absolute;
    animation: pulse 1.5s infinite;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: #0a0e1a;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.3); }
  }

  /* Export / notes */
  .notes-section {
    margin-bottom: 2rem;
    animation: fadeIn 0.7s ease 0.35s both;
  }

  .notes-area {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.875rem;
    width: 100%;
    min-height: 80px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }

  .notes-area:focus { border-color: var(--accent); }

  .actions {
    display: flex;
    gap: 0.75rem;
    animation: fadeIn 0.7s ease 0.4s both;
  }

  .btn-primary {
    background: var(--accent);
    border: none;
    color: var(--bg);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    padding: 0.6rem 1.4rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    transition: all 0.2s;
  }

  .btn-primary:hover { opacity: 0.85; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .row-num {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    width: 24px;
  }

  @media (max-width: 700px) {
    .summary-grid { grid-template-columns: repeat(2, 1fr); }
    .meta-row { grid-template-columns: 1fr; }
  }

  /* Expandable Mitigation Cell */
  .mit-cell {
    position: relative;
  }

  .mit-preview {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    padding: 0.35rem 0.6rem;
    border: 1px solid transparent;
    border-radius: 4px;
    transition: border-color 0.2s, background 0.2s;
    min-height: 32px;
  }

  .mit-preview:hover {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  .mit-preview-text {
    font-size: 0.82rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 170px;
    flex: 1;
  }

  .mit-preview-text.empty {
    color: var(--muted);
    font-style: italic;
  }

  .mit-arrow {
    font-size: 0.65rem;
    color: var(--accent);
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .mit-arrow.open {
    transform: rotate(180deg);
  }

  .mit-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    min-width: 280px;
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 0.75rem;
    z-index: 100;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }

  .mit-dropdown.open {
    display: block;
  }

  .mit-dropdown label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    display: block;
    margin-bottom: 0.4rem;
  }

  .mit-dropdown textarea {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 0.6rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.82rem;
    width: 100%;
    min-height: 90px;
    outline: none;
    resize: vertical;
    transition: border-color 0.2s;
  }

  .mit-dropdown textarea:focus {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  .mit-dropdown-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.5rem;
  }

  .mit-save-btn {
    background: var(--accent);
    border: none;
    color: var(--bg);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.3rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .mit-save-btn:hover { opacity: 0.8; }


  /* Expandable Owner Cell */
  .owner-cell { position: relative; }

  .owner-preview {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    padding: 0.35rem 0.6rem;
    border: 1px solid transparent;
    border-radius: 4px;
    transition: border-color 0.2s, background 0.2s;
    min-height: 32px;
  }

  .owner-preview:hover {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  .owner-preview-text {
    font-size: 0.82rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
    flex: 1;
  }

  .owner-preview-text.empty { color: var(--muted); font-style: italic; }

  .owner-arrow {
    font-size: 0.65rem;
    color: var(--accent);
    transition: transform 0.2s;
    flex-shrink: 0;
  }

  .owner-arrow.open { transform: rotate(180deg); }

  .owner-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    min-width: 240px;
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 0.75rem;
    z-index: 100;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }

  .owner-dropdown.open { display: block; }

  .owner-dropdown label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    display: block;
    margin-bottom: 0.4rem;
  }

  .owner-dropdown textarea {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 0.6rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.82rem;
    width: 100%;
    min-height: 70px;
    outline: none;
    resize: vertical;
    transition: border-color 0.2s;
  }

  .owner-dropdown textarea:focus {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  .owner-dropdown-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.5rem;
  }

  .owner-save-btn {
    background: var(--accent);
    border: none;
    color: var(--bg);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.3rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .owner-save-btn:hover { opacity: 0.8; }


  /* Quantitative Risk Section */
  .quant-section {
    margin-bottom: 2rem;
    animation: fadeIn 0.7s ease 0.3s both;
  }

  .quant-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .quant-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    transition: border-color 0.2s;
  }

  .quant-card:hover { border-color: var(--accent); }

  .quant-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .quant-card-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1rem;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .quant-card-badge {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.82rem;
    color: var(--muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 0.15rem 0.6rem;
  }

  .quant-formula {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.82rem;
    color: var(--muted);
    background: var(--surface2);
    border-radius: 4px;
    padding: 0.4rem 0.75rem;
    margin-bottom: 1rem;
    letter-spacing: 0.05em;
  }

  .quant-inputs {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin-bottom: 1rem;
  }

  .quant-input-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .quant-input-row label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.82rem;
    color: var(--muted);
    letter-spacing: 0.05em;
    width: 180px;
    flex-shrink: 0;
  }

  .quant-input-row input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 0.7rem;
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.95rem;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }

  .quant-input-row input:focus {
    border-color: var(--accent);
    background: rgba(0,229,255,0.04);
  }

  .quant-result {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.5rem;
  }

  .quant-result-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.78rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .quant-result-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--accent);
  }

  .quant-description {
    font-size: 0.92rem;
    color: var(--muted);
    line-height: 1.5;
    margin-bottom: 1rem;
  }

  .quant-summary {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    margin-top: 1rem;
  }

  .quant-summary-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .quant-summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  .quant-summary-item {
    text-align: center;
  }

  .quant-summary-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent);
  }

  .quant-summary-lbl {
    font-size: 0.78rem;
    font-weight: 700;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-top: 0.2rem;
  }

  @media (max-width: 700px) {
    .quant-grid { grid-template-columns: 1fr; }
    .quant-summary-grid { grid-template-columns: repeat(2, 1fr); }
  }




  /* Status Color Styles */
  .status-open        { color: #ff4d6d; border-color: #ff4d6d !important; background: rgba(255,77,109,0.08) !important; }
  .status-inprogress  { color: #ffd166; border-color: #ffd166 !important; background: rgba(255,209,102,0.08) !important; }
  .status-mitigated   { color: #ff9f40; border-color: #ff9f40 !important; background: rgba(255,159,64,0.08) !important; }
  .status-accepted    { color: #7fff6e; border-color: #7fff6e !important; background: rgba(127,255,110,0.08) !important; }

  /* Due Date */
  .col-due { min-width: 130px; }

  /* Chart */
  .chart-section { margin-bottom: 2rem; animation: fadeIn 0.7s ease 0.3s both; }
  .chart-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; }


  /* Matrix + Chart Side by Side */
  .matrix-chart-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
    align-items: start;
    animation: fadeIn 0.7s ease 0.3s both;
  }

  .matrix-col {
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .chart-col {
    min-width: 0;
    display: flex;
    flex-direction: column;
    max-height: 458px;
    height: 458px;
  }

  .chart-col .chart-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .chart-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    box-sizing: border-box;
  }

  .chart-bars {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    flex: 1;
    overflow-y: auto;
    max-height: 320px;
    padding-right: 0.25rem;
  }


  .chart-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    flex: 1;
  }

  .chart-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.88rem;
    color: var(--text);
    width: 175px;
    flex-shrink: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chart-bar-track {
    flex: 1;
    background: var(--surface2);
    border-radius: 100px;
    height: 28px;
    overflow: hidden;
  }

  .chart-bar-fill {
    height: 100%;
    border-radius: 100px;
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    padding-left: 0.6rem;
    min-width: 32px;
  }

  .chart-bar-count {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.78rem;
    font-weight: 700;
    color: #0a0e1a;
  }

  .chart-legend {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
    border-top: 1px solid var(--border);
    padding-top: 0.85rem;
    flex-shrink: 0;
  }

  .chart-legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .chart-legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  @media (max-width: 900px) {
    .matrix-chart-row { grid-template-columns: 1fr; }
  }


  /* Filter Bar */
  .filter-bar {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    animation: fadeIn 0.7s ease 0.2s both;
  }

  .filter-input {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.45rem 0.85rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.82rem;
    outline: none;
    transition: border-color 0.2s;
    flex: 1;
    min-width: 160px;
  }

  .filter-input:focus { border-color: var(--accent); }
  .filter-input option { background: var(--surface2); }

  .filter-count {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    white-space: nowrap;
  }


  /* Progress Tracker */
  .progress-section {
    margin-bottom: 2rem;
    animation: fadeIn 0.7s ease 0.15s both;
  }

  .progress-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .progress-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .progress-pct {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent);
  }

  .progress-track {
    width: 100%;
    height: 12px;
    background: var(--surface2);
    border-radius: 100px;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .progress-fill {
    height: 100%;
    border-radius: 100px;
    background: linear-gradient(90deg, var(--accent), #7fff6e);
    transition: width 0.6s ease;
  }

  .progress-stats {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .progress-stat {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .progress-stat span {
    font-weight: 700;
    color: var(--text);
  }




  /* Top 3 Critical Risks */
  .top3-section {
    margin-bottom: 2rem;
    animation: fadeIn 0.7s ease 0.12s both;
  }

  .top3-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .top3-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem 1.25rem;
    border-left: 3px solid var(--critical);
    transition: border-color 0.2s;
    position: relative;
    overflow: hidden;
  }

  .top3-card:hover { border-color: var(--critical); }

  .top3-rank {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.3rem;
  }

  .top3-threat {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.4rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .top3-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .top3-score {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.6rem;
    font-weight: 700;
    position: absolute;
    top: 0.6rem;
    right: 1rem;
    opacity: 1;
    text-shadow: 0 0 12px currentColor;
  }

  .top3-empty {
    color: var(--muted);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    font-style: italic;
  }

  @media (max-width: 700px) {
    .top3-grid { grid-template-columns: 1fr; }
  }


  /* Risk Appetite */
  .appetite-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .appetite-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  .appetite-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 160px;
    height: 4px;
    border-radius: 2px;
    background: var(--border);
    outline: none;
    cursor: pointer;
  }

  .appetite-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .appetite-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    font-weight: 600;
    min-width: 30px;
  }

  .matrix-cell.above-appetite {
    outline: 2px solid rgba(255,255,255,0.5);
    outline-offset: -2px;
  }


  /* Add Category Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open {
    display: flex;
  }

  .modal-box {
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 10px;
    padding: 1.75rem;
    width: 380px;
    max-width: 90vw;
    box-shadow: 0 16px 48px rgba(0,0,0,0.5);
  }

  .modal-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .modal-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.6rem 0.85rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.875rem;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 1rem;
  }

  .modal-input:focus { border-color: var(--accent); }

  .modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
  }

  .modal-cat-list {
    max-height: 180px;
    overflow-y: auto;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
    border-radius: 6px;
  }

  .modal-cat-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.82rem;
  }

  .modal-cat-item:last-child { border-bottom: none; }

  .modal-cat-remove {
    background: none;
    border: none;
    color: var(--critical);
    cursor: pointer;
    font-size: 0.75rem;
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    transition: background 0.2s;
  }

  .modal-cat-remove:hover { background: rgba(255,77,109,0.1); }

</style>
</head>
<body>
<div class="container">

  <header>
    <div class="label">// risk assessment</div>
    <h1>Risk Assessment</h1>
    <p>Identify, score, and track risks across your organization.</p>
  </header>

  <!-- Summary Dashboard -->
  <div class="summary-grid">
    <div class="summary-card critical">
      <div class="count" id="cnt-critical">0</div>
      <div class="label">Critical</div>
    </div>
    <div class="summary-card high">
      <div class="count" id="cnt-high">0</div>
      <div class="label">High</div>
    </div>
    <div class="summary-card medium">
      <div class="count" id="cnt-medium">0</div>
      <div class="label">Medium</div>
    </div>
    <div class="summary-card low">
      <div class="count" id="cnt-low">0</div>
      <div class="label">Low</div>
    </div>
  </div>



  <!-- Top 3 Critical Risks -->
  <div class="top3-section">
    <div class="section-header">
      <span class="section-title">// top risks by score</span>
    </div>
    <div class="top3-grid" id="top3-grid">
      <div class="top3-card"><div class="top3-empty">Add risks to see top threats...</div></div>
      <div class="top3-card"><div class="top3-empty"></div></div>
      <div class="top3-card"><div class="top3-empty"></div></div>
    </div>
  </div>

  <!-- Progress Tracker -->
  <div class="progress-section">
    <div class="progress-card">
      <div class="progress-header">
        <span class="progress-label">// mitigation progress</span>
        <span class="progress-pct" id="progress-pct">0%</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progress-fill" style="width:0%"></div>
      </div>
      <div class="progress-stats">
        <div class="progress-stat">Total Risks: <span id="prog-total">0</span></div>
        <div class="progress-stat">Mitigated: <span id="prog-mitigated" style="color:#ff9f40">0</span></div>
        <div class="progress-stat">Accepted: <span id="prog-accepted" style="color:#7fff6e">0</span></div>
        <div class="progress-stat">Open: <span id="prog-open" style="color:#ff4d6d">0</span></div>
        <div class="progress-stat">In Progress: <span id="prog-inprogress" style="color:#ffd166">0</span></div>
      </div>
    </div>
  </div>

  <!-- Meta Fields -->
  <div class="meta-row">
    <div class="field">
      <label>Organization / System</label>
      <input type="text" id="org" placeholder="e.g. Acme Corp â€” Cloud Infrastructure">
    </div>
    <div class="field">
      <label>Assessed By</label>
      <input type="text" id="assessor" placeholder="Name or team">
    </div>
    <div class="field">
      <label>Assessment Date</label>
      <input type="date" id="adate">
    </div>
  </div>

  <!-- Risk Register Table -->
  <div class="section-header">
    <span class="section-title">// risk register</span>
    <button class="btn" onclick="addRow()">+ Add Risk</button>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <input class="filter-input" type="text" id="filter-search" placeholder="ðŸ” Search by Risk ID, threat, category..." oninput="applyFilters()" list="riskid-suggestions" autocomplete="off">
    <datalist id="riskid-suggestions"></datalist>
    <select class="filter-input" id="filter-cat" onchange="handleCatFilter()">
      <option value="">All Categories</option>
    </select>
    <select class="filter-input" id="filter-rating" onchange="applyFilters()" style="min-width:130px;">
      <option value="">All Severities</option>
      <option>Critical</option>
      <option>High</option>
      <option>Medium</option>
      <option>Low</option>
    </select>
    <select class="filter-input" id="filter-status" onchange="applyFilters()" style="min-width:130px;">
      <option value="">All Statuses</option>
      <option>Open</option>
      <option>In Progress</option>
      <option>Mitigated</option>
      <option>Accepted</option>
    </select>
    <span class="filter-count" id="filter-count"></span>
  </div>

  <div class="risk-table-wrap">
    <table id="risk-table">
      <thead>
        <tr>
          <th class="col-num">#</th>
          <th class="col-id">Risk ID</th>
          <th class="col-threat">Risk / Threat</th>
          <th class="col-cat">Category</th>
          <th class="col-lik">Likelihood (1â€“5)</th>
          <th class="col-imp">Impact (1â€“5)</th>
          <th class="col-score">Score</th>
          <th class="col-rating">Rating</th>
          <th class="col-owner">Owner</th>
          <th class="col-mit">Mitigation</th>
          <th class="col-status">Status</th>
          <th class="col-due">Due Date</th>
          <th class="col-del">Delete</th>
        </tr>
      </thead>
      <tbody id="risk-body"></tbody>
    </table>
  </div>

  <!-- Risk Matrix + Chart Side by Side -->
  <div class="matrix-chart-row">
    <div class="matrix-col">
      <div class="section-header">
        <span class="section-title">// risk matrix</span>
      </div>
      <div class="matrix-grid" id="matrix-grid"></div>
      <div class="appetite-controls">
        <span class="appetite-label">Risk Appetite Threshold:</span>
        <input type="range" class="appetite-slider" id="appetite-slider" min="1" max="25" value="12" oninput="updateAppetite(this.value)">
        <span class="appetite-val" id="appetite-val">12</span>
        <span class="appetite-label">(cells above threshold highlighted)</span>
      </div>
    </div>
    <div class="chart-col">
      <div class="section-header">
        <span class="section-title">// risk distribution by category</span>
      </div>
      <div class="chart-wrap">
        <div class="chart-bars" id="chart-bars">
          <div style="color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:0.75rem;">Add risks to see distribution...</div>
        </div>
        <div class="chart-legend">
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--critical)"></div>Critical</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--high)"></div>High</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--medium)"></div>Medium</div>
          <div class="chart-legend-item"><div class="chart-legend-dot" style="background:var(--low)"></div>Low</div>
        </div>
      </div>
    </div>
  </div>





  <!-- Quantitative Risk Section -->
  <div class="quant-section">
    <div class="section-header" onclick="toggleQuant()" style="cursor:pointer;user-select:none;">
      <span class="section-title" style="font-size:1.1rem;letter-spacing:0.08em;">// quantitative risk analysis</span>
      <span id="quant-toggle-arrow" style="font-family:'IBM Plex Mono',monospace;font-size:0.85rem;color:var(--accent);transition:transform 0.3s;display:inline-block;">â–¼</span>
    </div>
    <div id="quant-body">

    <div class="quant-grid">

      <!-- Risk Selector -->
      <div style="grid-column:1/-1;">        <div style="margin-bottom:1rem;">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--accent);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:0.4rem;">Link to Risk Register</div>
          <select id="quant-risk-select" onchange="loadRiskToQuant()" style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0.4rem 0.6rem;color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:0.82rem;width:100%;outline:none;">
            <option value="">â€” Select a risk to auto-fill Asset Value â€”</option>
          </select>
        </div></div>

      <!-- SLE Card -->
      <div class="quant-card">
        <div class="quant-card-header">
          <span class="quant-card-title">Single <span style="color:#ff4d6d">Loss</span> Expectancy (SLE)</span>
          <span class="quant-card-badge">SLE</span>
        </div>
        <p class="quant-description">The expected monetary loss every time a risk event occurs once. Calculated by multiplying the asset value by the exposure factor.</p>
        <div class="quant-formula">SLE = Asset Value ($) Ã— Exposure Factor (%)</div>
        <div class="quant-inputs">
          <div class="quant-input-row">
            <label>Asset Value ($)</label>
            <input type="number" id="sle-av" placeholder="e.g. 500000" oninput="calcSLE()">
          </div>
          <div class="quant-input-row">
            <label>Exposure Factor (0â€“1)</label>
            <input type="number" id="sle-ef" placeholder="e.g. 0.30" min="0" max="1" step="0.01" oninput="calcSLE()">
          </div>
        </div>
        <div class="quant-result">
          <span class="quant-result-label">SLE Result</span>
          <span class="quant-result-value" id="sle-result">$0.00</span>
        </div>
      </div>

      <!-- EF Card -->
      <div class="quant-card">
        <div class="quant-card-header">
          <span class="quant-card-title">Exposure Factor (EF)</span>
          <span class="quant-card-badge">EF</span>
        </div>
        <p class="quant-description">The percentage of asset value lost if a specific threat occurs. Represents the impact severity on the asset, expressed as a decimal between 0 and 1.</p>
        <div class="quant-formula">EF = Loss from Incident ($) Ã· Total Asset Value ($)</div>
        <div class="quant-inputs">
          <div class="quant-input-row">
            <label>Loss from Incident ($)</label>
            <input type="number" id="ef-loss" placeholder="e.g. 150000" oninput="calcEF()">
          </div>
          <div class="quant-input-row">
            <label>Total Asset Value ($)</label>
            <input type="number" id="ef-av" placeholder="e.g. 500000" oninput="calcEF()">
          </div>
        </div>
        <div class="quant-result">
          <span class="quant-result-label">EF Result</span>
          <span class="quant-result-value" id="ef-result">0.00</span>
        </div>
      </div>

      <!-- ARO Card -->
      <div class="quant-card">
        <div class="quant-card-header">
          <span class="quant-card-title">Annual Rate of Occurrence (ARO)</span>
          <span class="quant-card-badge">ARO</span>
        </div>
        <p class="quant-description">How many times a threat is expected to occur within a year. An ARO of 0.5 means once every two years. An ARO of 2 means twice per year.</p>
        <div class="quant-formula">ARO = Number of Incidents Ã· Number of Years</div>
        <div class="quant-inputs">
          <div class="quant-input-row">
            <label>Number of Incidents</label>
            <input type="number" id="aro-incidents" placeholder="e.g. 3" oninput="calcARO()">
          </div>
          <div class="quant-input-row">
            <label>Over How Many Years</label>
            <input type="number" id="aro-years" placeholder="e.g. 5" oninput="calcARO()">
          </div>
        </div>
        <div class="quant-result">
          <span class="quant-result-label">ARO Result</span>
          <span class="quant-result-value" id="aro-result">0.00</span>
        </div>
      </div>

      <!-- ALE Card -->
      <div class="quant-card">
        <div class="quant-card-header">
          <span class="quant-card-title">Annual <span style="color:#ff4d6d">Loss</span> Expectancy (ALE)</span>
          <span class="quant-card-badge">ALE</span>
        </div>
        <p class="quant-description">The expected monetary loss for an asset due to a risk over a one-year period. This is the key metric used to justify security investment decisions.</p>
        <div class="quant-formula">ALE = SLE Ã— ARO</div>
        <div class="quant-inputs">
          <div class="quant-input-row">
            <label>SLE ($)</label>
            <input type="number" id="ale-sle" placeholder="e.g. 150000" oninput="calcALE()">
          </div>
          <div class="quant-input-row">
            <label>ARO (times/year)</label>
            <input type="number" id="ale-aro" placeholder="e.g. 0.5" step="0.01" oninput="calcALE()">
          </div>
        </div>
        <div class="quant-result">
          <span class="quant-result-label">ALE Result</span>
          <span class="quant-result-value" id="ale-result">$0.00</span>
        </div>
      </div>

    </div>

    <!-- Summary Bar -->
    <div class="quant-summary">
      <div class="quant-summary-title">// quantitative summary</div>
      <div class="quant-summary-grid">
        <div class="quant-summary-item">
          <div class="quant-summary-val" id="sum-sle">$0</div>
          <div class="quant-summary-lbl">SLE</div>
        </div>
        <div class="quant-summary-item">
          <div class="quant-summary-val" id="sum-ef">0.00</div>
          <div class="quant-summary-lbl">EF</div>
        </div>
        <div class="quant-summary-item">
          <div class="quant-summary-val" id="sum-aro">0.00</div>
          <div class="quant-summary-lbl">ARO</div>
        </div>
        <div class="quant-summary-item">
          <div class="quant-summary-val" id="sum-ale">$0</div>
          <div class="quant-summary-lbl">ALE</div>
        </div>
      </div>
    </div>
  </div>
  </div><!-- /quant-body -->

  <!-- Notes -->
  <div class="notes-section">
    <div class="section-header">
      <span class="section-title">// notes &amp; recommendations</span>
    </div>
    <textarea class="notes-area" id="notes" placeholder="Add overall findings, recommendations, or action items..."></textarea>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn-primary" onclick="exportCSV()">Export CSV</button>
    <button class="btn" onclick="emailReport()">ðŸ“§ Email Report</button>
    <button class="btn" onclick="printReport()">Print / Save PDF</button>
    <button class="btn danger" onclick="clearAll()">Clear All</button>
  </div>

  <!-- Add Category Modal -->
  <div class="modal-overlay" id="cat-modal">
    <div class="modal-box">
      <div class="modal-title">// <span style="color:var(--accent)">+ Add</span> / <span style="color:var(--critical)">Delete</span> Categories</div>
      <div class="modal-cat-list" id="modal-cat-list"></div>
      <input class="modal-input" type="text" id="new-cat-input" placeholder="New category name..." onkeydown="if(event.key==='Enter') addCategory()">
      <div class="modal-actions">
        <button class="btn" onclick="closeCatModal()">Cancel</button>
        <button class="btn" onclick="addCategory()">+ Add Category</button>
        <button class="btn-primary" onclick="applyAndClose()">âœ“ Apply</button>
      </div>
    </div>
  </div>

</div>

<script>
const CATEGORIES = ['Access Control','Application Security','Compliance / Regulatory','Data Protection','Endpoint Security','Incident Response','Network Security','Physical Security','Social Engineering','Supply Chain'];
const STATUSES = ['Open','In Progress','Mitigated','Accepted'];

let rows = [];
let rowCounter = 0;

const defaultRisks = [
  { threat: 'Phishing / Credential Theft', cat: 'Social Engineering', l: 4, i: 4, owner: '', mitigation: 'MFA, security awareness training', status: 'Open' },
  { threat: 'Unpatched Software Vulnerabilities', cat: 'Endpoint Security', l: 3, i: 5, owner: '', mitigation: 'Patch management policy, automated scanning', status: 'Open' },
  { threat: 'Insider Threat / Privilege Abuse', cat: 'Access Control', l: 2, i: 5, owner: '', mitigation: 'Least privilege, UEBA monitoring', status: 'Open' },
  { threat: 'Ransomware Attack', cat: 'Endpoint Security', l: 3, i: 5, owner: '', mitigation: 'Backups, EDR, network segmentation', status: 'Open' },
  { threat: 'Misconfigured Cloud Storage', cat: 'Data Protection', l: 3, i: 4, owner: '', mitigation: 'CSPM tooling, cloud security review', status: 'Open' },
  { threat: 'Third-Party Vendor Breach', cat: 'Supply Chain', l: 2, i: 4, owner: '', mitigation: 'Vendor risk assessments, contract clauses', status: 'Open' },
];

function getRating(score) {
  if (score >= 20) return 'Critical';
  if (score >= 12) return 'High';
  if (score >= 6) return 'Medium';
  return 'Low';
}

function getBadgeClass(rating) {
  return 'badge-' + rating.toLowerCase();
}

function getScoreColor(score) {
  if (score >= 20) return 'var(--critical)';
  if (score >= 12) return 'var(--high)';
  if (score >= 6) return 'var(--medium)';
  return 'var(--low)';
}

function addRow(data = {}) {
  rowCounter++; 
  const id = rowCounter;
  const row = {
    id,
    riskId: data.riskId || '',
    threat: data.threat || '',
    due: data.due || '',
    cat: data.cat || CATEGORIES[0],
    l: data.l || 3,
    i: data.i || 3,
    owner: data.owner || '',
    mitigation: data.mitigation || '',
    status: data.status || 'Open'
  };
  rows.push(row);
  reassignRiskIds();
  renderTable();
  updateSummary();
  renderMatrix();
  renderChart();
  saveData();
}

function removeRow(id) {
  rows = rows.filter(r => r.id !== id);
  reassignRiskIds();
  renderTable();
  updateSummary();
  renderMatrix();
  renderChart();
  saveData();
}

function updateRow(id, field, value) {
  const row = rows.find(r => r.id === id);
  if (!row) return;
  row[field] = field === 'l' || field === 'i' ? parseInt(value) : value;
  updateSummary();
  renderMatrix();
  renderChart();
  saveData();
  // update score + badge in table
  const score = row.l * row.i;
  const rating = getRating(score);
  const scoreEl = document.getElementById(`score-${id}`);
  const badgeEl = document.getElementById(`badge-${id}`);
  if (scoreEl) {
    scoreEl.textContent = score;
    scoreEl.style.color = getScoreColor(score);
  }
  if (badgeEl) {
    badgeEl.textContent = rating;
    badgeEl.className = 'risk-badge ' + getBadgeClass(rating);
  }
}

function renderTable() {
  const tbody = document.getElementById('risk-body');
  tbody.innerHTML = '';
  rows.forEach((row, idx) => {
    const score = row.l * row.i;
    const rating = getRating(score);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="row-num">${idx + 1}</td>
      <td><input type="text" value="${escHtml(row.riskId)}" onchange="updateRow(${row.id},'riskId',this.value)" style="font-family:'IBM Plex Mono',monospace;font-size:0.72rem;color:var(--accent);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0.2rem 0.5rem;width:90px;outline:none;text-align:center;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></td>
      <td><input type="text" value="${escHtml(row.threat)}" placeholder="Describe threat..." onchange="updateRow(${row.id},'threat',this.value)" style="min-width:220px"></td>
      <td>
        <select onchange="updateRow(${row.id},'cat',this.value)" style="min-width:180px">
          ${CATEGORIES.map(c => `<option value="${c}" ${c===row.cat?'selected':''}>${c}</option>`).join('')}
        </select>
      </td>
      <td style="text-align:center">
        <select onchange="updateRow(${row.id},'l',this.value)" style="width:50px;text-align:center">
          ${[1,2,3,4,5].map(n=>`<option value="${n}" ${n===row.l?'selected':''}>${n}</option>`).join('')}
        </select>
      </td>
      <td style="text-align:center">
        <select onchange="updateRow(${row.id},'i',this.value)" style="width:50px;text-align:center">
          ${[1,2,3,4,5].map(n=>`<option value="${n}" ${n===row.i?'selected':''}>${n}</option>`).join('')}
        </select>
      </td>
      <td class="score-cell" id="score-${row.id}" style="color:${getScoreColor(score)}">${score}</td>
      <td><span class="risk-badge ${getBadgeClass(rating)}" id="badge-${row.id}">${rating}</span></td>
      <td class="owner-cell" style="position:relative;min-width:130px">
        <div class="owner-preview" onclick="toggleOwner(${row.id}, this)">
          <span class="owner-preview-text ${row.owner ? '' : 'empty'}" id="owner-preview-${row.id}">${row.owner ? escHtml(row.owner).substring(0,25) + (row.owner.length > 25 ? 'â€¦' : '') : 'Add owner...'}</span>
          <span class="owner-arrow" id="owner-arrow-${row.id}">â–¼</span>
        </div>
        <div class="owner-dropdown" id="owner-drop-${row.id}">
          <label>Owner / Responsible Party</label>
          <textarea id="owner-text-${row.id}" placeholder="Name, team, or role responsible...">${escHtml(row.owner)}</textarea>
          <div class="owner-dropdown-footer">
            <button class="owner-save-btn" onclick="saveOwner(${row.id})">Save âœ“</button>
          </div>
        </div>
      </td>
      <td class="mit-cell" style="position:relative;min-width:210px">
        <div class="mit-preview" onclick="toggleMit(${row.id}, this)">
          <span class="mit-preview-text ${row.mitigation ? '' : 'empty'}" id="mit-preview-${row.id}">${row.mitigation ? escHtml(row.mitigation).substring(0,40) + (row.mitigation.length > 40 ? 'â€¦' : '') : 'Add mitigation...'}</span>
          <span class="mit-arrow" id="mit-arrow-${row.id}">â–¼</span>
        </div>
        <div class="mit-dropdown" id="mit-drop-${row.id}">
          <label>Mitigation / Controls</label>
          <textarea id="mit-text-${row.id}" placeholder="Describe controls, actions, or mitigations...">${escHtml(row.mitigation)}</textarea>
          <div class="mit-dropdown-footer">
            <button class="mit-save-btn" onclick="saveMit(${row.id})">Save âœ“</button>
          </div>
        </div>
      </td>
      <td>
        <select onchange="updateRow(${row.id},'status',this.value); applyStatusColor(this, this.value)" id="status-sel-${row.id}" class="status-select ${getStatusClass(row.status)}" style="min-width:130px;font-weight:600;border:1px solid;border-radius:4px;padding:0.35rem 0.6rem;outline:none;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;font-size:0.82rem;">
          ${STATUSES.map(s=>`<option value="${s}" ${s===row.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td><input type="date" value="${row.due}" onchange="updateRow(${row.id},'due',this.value)" style="background:transparent;border:1px solid var(--border);border-radius:4px;padding:0.35rem 0.5rem;color:var(--text);font-family:'IBM Plex Sans',sans-serif;font-size:0.82rem;outline:none;width:100%;"></td>
      <td style="text-align:center"><button class="btn danger" onclick="removeRow(${row.id})" style="padding:0.35rem 0.8rem;font-size:0.72rem;letter-spacing:0.05em">ðŸ—‘ Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function updateSummary() {
  const counts = { Critical: 0, High: 0, Medium: 0, Low: 0 };
  rows.forEach(r => { counts[getRating(r.l * r.i)]++; });
  document.getElementById('cnt-critical').textContent = counts.Critical;
  document.getElementById('cnt-high').textContent = counts.High;
  document.getElementById('cnt-medium').textContent = counts.Medium;
  document.getElementById('cnt-low').textContent = counts.Low;
  updateProgress();
  updateQuantSelect();
  renderTop3();
}

function renderMatrix() {
  const grid = document.getElementById('matrix-grid');
  grid.innerHTML = '';

  // Build a set of (l,i) positions from current risks
  const positions = rows.map(r => ({ l: r.l, i: r.i }));

  // Y-axis title
  const yTitle = document.createElement('div');
  yTitle.className = 'y-axis-title';
  yTitle.textContent = 'Impact â†’';
  grid.appendChild(yTitle);

  // Matrix cells (impact 5 top, likelihood 1 left)
  for (let imp = 5; imp >= 1; imp--) {
    for (let lik = 1; lik <= 5; lik++) {
      const score = lik * imp;
      const cell = document.createElement('div');
      cell.className = 'matrix-cell';
      
      let bg;
      if (score >= 20) bg = 'rgba(255,77,109,0.25)';
      else if (score >= 12) bg = 'rgba(255,159,64,0.2)';
      else if (score >= 6) bg = 'rgba(255,209,102,0.18)';
      else bg = 'rgba(127,255,110,0.15)';
      
      cell.style.background = bg;
      cell.style.color = score >= 20 ? 'var(--critical)' : score >= 12 ? 'var(--high)' : score >= 6 ? 'var(--medium)' : 'var(--low)';
      cell.textContent = score;

      // Check if any risks fall here
      const count = positions.filter(p => p.l === lik && p.i === imp).length;
      if (count > 0) {
        const dot = document.createElement('div');
        dot.className = 'dot-indicator';
        dot.style.top = '4px';
        dot.style.right = '4px';
        if (count > 1) {
          dot.textContent = count;
          dot.style.fontSize = '0.75rem';
          dot.style.width = '20px';
          dot.style.height = '20px';
          dot.style.display = 'flex';
          dot.style.alignItems = 'center';
          dot.style.justifyContent = 'center';
        }
        cell.appendChild(dot);
      }

      cell.title = `Likelihood: ${lik}, Impact: ${imp}, Score: ${score}`;
      grid.appendChild(cell);
    }
  }

  // X-axis labels
  const emptyCorner = document.createElement('div');
  grid.appendChild(emptyCorner);
  for (let lik = 1; lik <= 5; lik++) {
    const lbl = document.createElement('div');
    lbl.className = 'axis-label';
    lbl.textContent = lik;
    grid.appendChild(lbl);
  }

  // X-axis title
  const xTitle = document.createElement('div');
  xTitle.className = 'x-axis-title';
  xTitle.textContent = 'Likelihood â†’';
  grid.appendChild(xTitle);
}

function exportCSV() {
  const org = document.getElementById('org').value;
  const assessor = document.getElementById('assessor').value;
  const date = document.getElementById('adate').value;
  let csv = `Risk Assessment\nOrganization: ${org}\nAssessor: ${assessor}\nDate: ${date}\n\n`;
  csv += '#,Risk ID,Risk / Threat,Category,Likelihood,Impact,Score,Rating,Owner,Mitigation,Status,Due Date\n';
  rows.forEach((r, i) => {
    const score = r.l * r.i;
    csv += `${i+1},"${r.riskId}","${r.threat}","${r.cat}",${r.l},${r.i},${score},${getRating(score)},"${r.owner}","${r.mitigation}","${r.status}","${r.due}"\n`;
  });
  const notes = document.getElementById('notes').value;
  if (notes) csv += `\nNotes:\n"${notes}"\n`;
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cybersecurity-risk-assessment.csv';
  a.click();
}

function printReport() {
  window.print();
}

function clearAll() {
  if (!confirm('Clear all risks? This cannot be undone.')) return;
  rows = [];
  rowCounter = 0;
  renderTable();
  updateSummary();
  renderMatrix();
  renderChart();
  saveData();
}



function applyStatusColor(el, status) {
  el.className = 'status-select ' + getStatusClass(status);
}

function applyAllStatusColors() {
  rows.forEach(function(r) {
    var el = document.getElementById('status-sel-' + r.id);
    if (el) applyStatusColor(el, r.status);
  });
}



function updateQuantSelect() {
  var sel = document.getElementById('quant-risk-select');
  if (!sel) return;
  var current = sel.value;
  sel.innerHTML = '<option value="">â€” Select a risk to auto-fill Asset Value â€”</option>';
  rows.forEach(function(r) {
    var score = r.l * r.i;
    var rating = getRating(score);
    var opt = document.createElement('option');
    opt.value = r.id;
    opt.textContent = r.riskId + ' â€” ' + (r.threat || 'Unnamed risk') + ' (' + rating + ')';
    sel.appendChild(opt);
  });
  if (current) sel.value = current;
  // Update search datalist with current Risk IDs
  var dl = document.getElementById('riskid-suggestions');
  if (dl) {
    dl.innerHTML = '';
    rows.forEach(function(r) {
      var opt = document.createElement('option');
      opt.value = r.riskId;
      opt.label = r.threat || 'Unnamed risk';
      dl.appendChild(opt);
    });
  }
}

function loadRiskToQuant() {
  var sel = document.getElementById('quant-risk-select');
  if (!sel || !sel.value) return;
  var id = parseInt(sel.value);
  var row = rows.find(function(r) { return r.id === id; });
  if (!row) return;
  var score = row.l * row.i;
  var assetGuess = score * 10000;
  var avInput = document.getElementById('sle-av');
  if (avInput) { avInput.value = assetGuess; calcSLE(); }
}

function applyFilters() {
  var search = document.getElementById('filter-search').value.toLowerCase();
  var cat = document.getElementById('filter-cat').value;
  var rating = document.getElementById('filter-rating').value;
  var status = document.getElementById('filter-status').value;
  var tbody = document.getElementById('risk-body');
  var trs = tbody.querySelectorAll('tr');
  var visible = 0;
  trs.forEach(function(tr, idx) {
    var row = rows[idx];
    if (!row) return;
    var score = row.l * row.i;
    var rowRating = getRating(score);
    var matchSearch = !search || row.riskId.toLowerCase().includes(search) || row.threat.toLowerCase().includes(search) || row.cat.toLowerCase().includes(search) || (row.mitigation && row.mitigation.toLowerCase().includes(search)) || (row.owner && row.owner.toLowerCase().includes(search));
    var matchCat = !cat || row.cat === cat;
    var matchRating = !rating || rowRating === rating;
    var matchStatus = !status || row.status === status;
    if (matchSearch && matchCat && matchRating && matchStatus) {
      tr.style.display = '';
      visible++;
    } else {
      tr.style.display = 'none';
    }
  });
  var countEl = document.getElementById('filter-count');
  if (countEl) countEl.textContent = 'Showing ' + visible + ' of ' + rows.length;
}

function updateProgress() {
  var total = rows.length;
  var mitigated = rows.filter(function(r) { return r.status === 'Mitigated'; }).length;
  var accepted = rows.filter(function(r) { return r.status === 'Accepted'; }).length;
  var open = rows.filter(function(r) { return r.status === 'Open'; }).length;
  var inprogress = rows.filter(function(r) { return r.status === 'In Progress'; }).length;
  var resolved = mitigated + accepted;
  var pct = total > 0 ? Math.round((resolved / total) * 100) : 0;

  var pctEl = document.getElementById('progress-pct');
  var fillEl = document.getElementById('progress-fill');
  var totalEl = document.getElementById('prog-total');
  var mitEl = document.getElementById('prog-mitigated');
  var accEl = document.getElementById('prog-accepted');
  var openEl = document.getElementById('prog-open');
  var ipEl = document.getElementById('prog-inprogress');

  if (pctEl) pctEl.textContent = pct + '%';
  if (fillEl) fillEl.style.width = pct + '%';
  if (totalEl) totalEl.textContent = total;
  if (mitEl) mitEl.textContent = mitigated;
  if (accEl) accEl.textContent = accepted;
  if (openEl) openEl.textContent = open;
  if (ipEl) ipEl.textContent = inprogress;
}

function renderTop3() {
  var grid = document.getElementById('top3-grid');
  if (!grid) return;
  var sorted = rows.slice().sort(function(a, b) { return (b.l * b.i) - (a.l * a.i); });
  var top3 = sorted.slice(0, 3);
  var borderColors = ['var(--critical)', 'var(--high)', 'var(--medium)'];
  var rankLabels = ['#1 Highest Risk', '#2 High Risk', '#3 Notable Risk'];
  var html = '';
  for (var i = 0; i < 3; i++) {
    var r = top3[i];
    if (r) {
      var score = r.l * r.i;
      var rating = getRating(score);
      var bc = score >= 20 ? 'var(--critical)' : score >= 12 ? 'var(--high)' : score >= 6 ? 'var(--medium)' : 'var(--low)';
      html += '<div class="top3-card" style="border-left-color:' + bc + '">';
      html += '<div class="top3-score" style="color:' + bc + '">' + score + '</div>';
      html += '<div class="top3-rank">' + rankLabels[i] + ' &nbsp;Â·&nbsp; ' + r.riskId + '</div>';
      html += '<div class="top3-threat">' + (r.threat || 'Unnamed risk') + '</div>';
      html += '<div class="top3-meta"><span class="risk-badge ' + getBadgeClass(rating) + '">' + rating + '</span>';
      html += '<span style="font-size:0.68rem;color:var(--muted);">' + r.cat + '</span></div>';
      html += '</div>';
    } else {
      html += '<div class="top3-card"><div class="top3-empty">' + (i === 0 ? 'Add risks to see top threats...' : '') + '</div></div>';
    }
  }
  grid.innerHTML = html;
}

function updateAppetite(val) {
  var valEl = document.getElementById('appetite-val');
  if (valEl) valEl.textContent = val;
  var cells = document.querySelectorAll('.matrix-cell');
  cells.forEach(function(cell) {
    var score = parseInt(cell.textContent);
    if (!isNaN(score)) {
      if (score > parseInt(val)) {
        cell.style.outline = '2px solid rgba(255,255,255,0.6)';
        cell.style.outlineOffset = '-2px';
      } else {
        cell.style.outline = 'none';
      }
    }
  });
}

function emailReport() {
  var org = document.getElementById('org').value || 'Organization';
  var assessor = document.getElementById('assessor').value || 'Assessor';
  var date = document.getElementById('adate').value || new Date().toISOString().split('T')[0];
  var counts = { Critical: 0, High: 0, Medium: 0, Low: 0 };
  rows.forEach(function(r) { counts[getRating(r.l * r.i)]++; });
  var subject = 'GRC Risk Assessment Report â€” ' + org + ' (' + date + ')';
  var body = 'GRC Risk Assessment Report\n';
  body += '================================\n';
  body += 'Organization: ' + org + '\n';
  body += 'Assessed By: ' + assessor + '\n';
  body += 'Date: ' + date + '\n';
  body += 'Total Risks: ' + rows.length + '\n\n';
  body += 'Risk Summary:\n';
  body += '  Critical: ' + counts.Critical + '\n';
  body += '  High: ' + counts.High + '\n';
  body += '  Medium: ' + counts.Medium + '\n';
  body += '  Low: ' + counts.Low + '\n\n';
  body += 'Top Risks:\n';
  var sorted = rows.slice().sort(function(a,b){ return (b.l*b.i)-(a.l*a.i); }).slice(0,5);
  sorted.forEach(function(r, i) {
    body += (i+1) + '. [' + r.riskId + '] ' + (r.threat || 'Unnamed') + ' â€” Score: ' + (r.l*r.i) + ' (' + getRating(r.l*r.i) + ')\n';
  });
  var notes = document.getElementById('notes').value;
  if (notes) { body += '\nNotes:\n' + notes + '\n'; }
  body += '\nâ€” Generated by GRC Risk Assessment Tool Â© 2026 Orlando';
  window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
}

function reassignRiskIds() {
  rows.forEach(function(r, idx) {
    r.riskId = 'RISK-' + String(idx + 1).padStart(3, '0');
  });
}


function populateCatFilter() {
  var sel = document.getElementById('filter-cat');
  if (!sel) return;
  var current = sel.value;
  sel.innerHTML = '<option value="">All Categories</option>';
  var sorted = CATEGORIES.slice().sort();
  sorted.forEach(function(c) {
    var opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
  // Add Category option at bottom
  var divider = document.createElement('option');
  divider.disabled = true;
  divider.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
  sel.appendChild(divider);
  var addOpt = document.createElement('option');
  addOpt.value = '__add__';
  addOpt.textContent = '+ Add / Delete Categories...';
  addOpt.style.color = '#00e5ff';
  addOpt.style.fontStyle = 'italic';
  sel.appendChild(addOpt);
  if (current && current !== '__add__') sel.value = current;
}

function handleCatFilter() {
  var sel = document.getElementById('filter-cat');
  if (sel.value === '__add__') {
    sel.value = '';
    openCatModal();
    return;
  }
  applyFilters();
}

function openCatModal() {
  renderModalCatList();
  document.getElementById('cat-modal').classList.add('open');
  document.getElementById('new-cat-input').focus();
}


function applyAndClose() {
  populateCatFilter();
  renderTable();
  saveData();
  closeCatModal();
}

function closeCatModal() {
  document.getElementById('cat-modal').classList.remove('open');
  document.getElementById('new-cat-input').value = '';
}

function renderModalCatList() {
  var list = document.getElementById('modal-cat-list');
  if (!list) return;
  var sorted = CATEGORIES.slice().sort();
  var defaultCats = ['Access Control','Application Security','Compliance / Regulatory','Data Protection',
    'Endpoint Security','Incident Response','Network Security','Physical Security',
    'Social Engineering','Supply Chain'];
  var html = '';
  sorted.forEach(function(c) {
    var isDefault = defaultCats.indexOf(c) !== -1;
    html += '<div class="modal-cat-item">';
    html += '<span>' + c + '</span>';
    if (isDefault) {
      html += '<span style="font-size:0.65rem;color:var(--muted);">default</span>';
    } else {
      html += '<button class="modal-cat-remove" onclick="removeCategory(this)" data-cat="' + c + '" title="Remove">âœ•</button>';
    }
    html += '</div>';
  });
  list.innerHTML = html;
}

function addCategory() {
  var input = document.getElementById('new-cat-input');
  var val = input.value.trim();
  if (!val) return;
  if (CATEGORIES.indexOf(val) !== -1) {
    input.style.borderColor = 'var(--critical)';
    setTimeout(function() { input.style.borderColor = ''; }, 1000);
    return;
  }
  CATEGORIES.push(val);
  CATEGORIES.sort();
  input.value = '';
  renderModalCatList();
  populateCatFilter();
  renderTable();
  saveData();
}

function removeCategory(btn) {
  var cat = btn.getAttribute('data-cat');
  var inUse = rows.some(function(r) { return r.cat === cat; });
  if (inUse) {
    alert('Cannot remove "' + cat + '" â€” it is assigned to one or more risks.');
    return;
  }
  var idx = CATEGORIES.indexOf(cat);
  if (idx !== -1) CATEGORIES.splice(idx, 1);
  renderModalCatList();
  populateCatFilter();
  saveData();
}

// Close modal on overlay click
document.getElementById('cat-modal').addEventListener('click', function(e) {
  if (e.target === this) closeCatModal();
});


function toggleQuant() {
  var body = document.getElementById('quant-body');
  var arrow = document.getElementById('quant-toggle-arrow');
  if (!body) return;
  if (body.style.display === 'none') {
    body.style.display = '';
    arrow.style.transform = 'rotate(0deg)';
  } else {
    body.style.display = 'none';
    arrow.style.transform = 'rotate(-90deg)';
  }
}

function getStatusClass(status) {
  if (status === 'Open') return 'status-open';
  if (status === 'In Progress') return 'status-inprogress';
  if (status === 'Mitigated') return 'status-mitigated';
  if (status === 'Accepted') return 'status-accepted';
  return '';
}

function renderChart() {
  var container = document.getElementById('chart-bars');
  if (!container) return;
  if (rows.length === 0) {
    container.innerHTML = '<div style="color:#64748b;font-family:monospace;font-size:0.75rem;">Add risks to see distribution...</div>';
    return;
  }
  var catCounts = {};
  rows.forEach(function(r) {
    if (!catCounts[r.cat]) catCounts[r.cat] = { Critical:0, High:0, Medium:0, Low:0, total:0 };
    var rating = getRating(r.l * r.i);
    catCounts[r.cat][rating]++;
    catCounts[r.cat].total++;
  });
  var maxCount = 0;
  Object.keys(catCounts).forEach(function(k) { if (catCounts[k].total > maxCount) maxCount = catCounts[k].total; });
  var sorted = Object.keys(catCounts).sort(function(a,b) { return catCounts[b].total - catCounts[a].total; });
  var html = '';
  sorted.forEach(function(cat) {
    var counts = catCounts[cat];
    var pct = maxCount > 0 ? (counts.total / maxCount) * 100 : 0;
    var barColor = counts.Critical > 0 ? '#ff4d6d' : counts.High > 0 ? '#ff9f40' : counts.Medium > 0 ? '#ffd166' : '#7fff6e';
    html += '<div class="chart-row">';
    html += '<div class="chart-label" title="' + cat + '">' + cat + '</div>';
    html += '<div class="chart-bar-track">';
    html += '<div class="chart-bar-fill" style="width:' + pct + '%;background:' + barColor + '">';
    html += '<span class="chart-bar-count">' + counts.total + '</span>';
    html += '</div></div></div>';
  });
  container.innerHTML = html;
}

function saveData() {
  try {
    var data = {
      org: document.getElementById('org').value,
      assessor: document.getElementById('assessor').value,
      adate: document.getElementById('adate').value,
      notes: document.getElementById('notes').value,
      rows: rows,
      categories: CATEGORIES
    };
    localStorage.setItem('grc-risk-data', JSON.stringify(data));
  } catch(e) {}
}

function loadData() {
  try {
    var saved = localStorage.getItem('grc-risk-data');
    if (!saved) return false;
    var data = JSON.parse(saved);
    document.getElementById('org').value = data.org || '';
    document.getElementById('assessor').value = data.assessor || '';
    document.getElementById('adate').value = data.adate || new Date().toISOString().split('T')[0];
    document.getElementById('notes').value = data.notes || '';
    // Restore custom categories
    if (data.categories && data.categories.length > 0) {
      data.categories.forEach(function(c) {
        if (CATEGORIES.indexOf(c) === -1) CATEGORIES.push(c);
      });
      CATEGORIES.sort();
    }
    if (data.rows && data.rows.length > 0) {
      data.rows.forEach(function(r) {
        rowCounter = Math.max(rowCounter, r.id);
        rows.push(r);
      });
      renderTable();
      updateSummary();
      renderMatrix();
      renderChart();
      populateCatFilter();
      return true;
    }
  } catch(e) {}
  return false;
}

document.addEventListener('change', saveData);
document.addEventListener('input', saveData);

// Init
document.getElementById('adate').value = new Date().toISOString().split('T')[0];
populateCatFilter();
if (!loadData()) { defaultRisks.forEach(r => addRow(r)); }
updateQuantSelect();

function toggleMit(id, previewEl) {
  const drop = document.getElementById('mit-drop-' + id);
  const arrow = document.getElementById('mit-arrow-' + id);
  const isOpen = drop.classList.contains('open');

  // Close all other open dropdowns first
  document.querySelectorAll('.mit-dropdown.open').forEach(d => d.classList.remove('open'));
  document.querySelectorAll('.mit-arrow.open').forEach(a => a.classList.remove('open'));

  if (!isOpen) {
    drop.classList.add('open');
    arrow.classList.add('open');
    document.getElementById('mit-text-' + id).focus();
  }
}

function saveMit(id) {
  const val = document.getElementById('mit-text-' + id).value;
  updateRow(id, 'mitigation', val);
  const preview = document.getElementById('mit-preview-' + id);
  preview.textContent = val ? (val.substring(0, 40) + (val.length > 40 ? 'â€¦' : '')) : 'Add mitigation...';
  preview.className = 'mit-preview-text' + (val ? '' : ' empty');
  document.getElementById('mit-drop-' + id).classList.remove('open');
  document.getElementById('mit-arrow-' + id).classList.remove('open');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.mit-cell')) {
    document.querySelectorAll('.mit-dropdown.open').forEach(d => d.classList.remove('open'));
    document.querySelectorAll('.mit-arrow.open').forEach(a => a.classList.remove('open'));
  }
});


function toggleOwner(id, previewEl) {
  const drop = document.getElementById('owner-drop-' + id);
  const arrow = document.getElementById('owner-arrow-' + id);
  const isOpen = drop.classList.contains('open');

  document.querySelectorAll('.owner-dropdown.open').forEach(d => d.classList.remove('open'));
  document.querySelectorAll('.owner-arrow.open').forEach(a => a.classList.remove('open'));

  if (!isOpen) {
    drop.classList.add('open');
    arrow.classList.add('open');
    document.getElementById('owner-text-' + id).focus();
  }
}

function saveOwner(id) {
  const val = document.getElementById('owner-text-' + id).value;
  updateRow(id, 'owner', val);
  const preview = document.getElementById('owner-preview-' + id);
  preview.textContent = val ? (val.substring(0, 25) + (val.length > 25 ? 'â€¦' : '')) : 'Add owner...';
  preview.className = 'owner-preview-text' + (val ? '' : ' empty');
  document.getElementById('owner-drop-' + id).classList.remove('open');
  document.getElementById('owner-arrow-' + id).classList.remove('open');
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.owner-cell')) {
    document.querySelectorAll('.owner-dropdown.open').forEach(d => d.classList.remove('open'));
    document.querySelectorAll('.owner-arrow.open').forEach(a => a.classList.remove('open'));
  }
});


function fmt(n) {
  return '<span style="color:#00c853">$</span> ' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function calcSLE() {
  const av = parseFloat(document.getElementById('sle-av').value) || 0;
  const ef = parseFloat(document.getElementById('sle-ef').value) || 0;
  const sle = av * ef;
  document.getElementById('sle-result').innerHTML = fmt(sle);
  document.getElementById('sum-sle').innerHTML = fmt(sle);
}

function calcEF() {
  const loss = parseFloat(document.getElementById('ef-loss').value) || 0;
  const av = parseFloat(document.getElementById('ef-av').value) || 1;
  const ef = av > 0 ? loss / av : 0;
  document.getElementById('ef-result').textContent = ef.toFixed(4);
  document.getElementById('sum-ef').textContent = ef.toFixed(4);
}

function calcARO() {
  const incidents = parseFloat(document.getElementById('aro-incidents').value) || 0;
  const years = parseFloat(document.getElementById('aro-years').value) || 1;
  const aro = years > 0 ? incidents / years : 0;
  document.getElementById('aro-result').textContent = aro.toFixed(2);
  document.getElementById('sum-aro').textContent = aro.toFixed(2);
}

function calcALE() {
  const sle = parseFloat(document.getElementById('ale-sle').value) || 0;
  const aro = parseFloat(document.getElementById('ale-aro').value) || 0;
  const ale = sle * aro;
  document.getElementById('ale-result').innerHTML = fmt(ale);
  document.getElementById('sum-ale').innerHTML = fmt(ale);
}




</script>

<div style="text-align:center; padding: 2rem 0 1rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: #64748b; letter-spacing: 0.1em;">
  Â© 2026 Orlando Â· GRC Risk Assessment Tool Â· All Rights Reserved
</div>

</body>
</html>
